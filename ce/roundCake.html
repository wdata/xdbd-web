<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>圆饼图</title>
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../plugin/jquery-ui/jquery-ui.min.css">
    <link rel="stylesheet" href="./css/common.css">
    <link rel="stylesheet" href="../css/BI_d3.css">
</head>
<body>


<div data-type="chart" type="bar" id="chartDFAB2A73" class="resize-item">
    <!--定位层-->
    <div class="positioning">
        <!--背景样式、边框线、透明度、圆角-->
        <div class="inform">
            <h2 class="chartTitle">未命名报表</h2>
            <div class="resize-content">
                <div class="legend"></div>
                <div id="resize-chart" class="resize-chart"></div>
            </div>
        </div>
    </div>
</div>

<script src="../plugin/jQuery/jquery.min.js"></script>
<script src="../plugin/jQuery/jQuery_ui.js"></script>
<script src="../plugin/d3/d3.v3.min.js"></script>
<script  src="../plugin/d3/d3.tip.js"></script>
<script  src="js/data.js"></script>
<script src="./js/common.js"></script>
<script>
    $(function(){
        var cs = new chartStyle("#chartDFAB2A73",CStyle);
        cs.title();
        cs.background();
        chartLegend("#chartDFAB2A73",roundCake1,CStyle);
        pieChart("#chartDFAB2A73",roundCake1,CStyle);
//        cs.reset();
    });

    function pieChart(elemt,data,CStyle){
        const margin = {top: 20, right: 30, bottom: 40, left: 55, titleLeft: -45,titleBottom:39 },   // 外部留空
            defaultColor = "#1496D4",    // 默认图表颜色
            id = elemt + " .resize-chart",   // 存放图形的位置
            el =  elemt + " .legend";   // 存放图例的样式，可用以确定图例宽高

        // 数据
        const total = data.data;                                      // 数据

        const queryJson = total.queryJson,                             // 索引数据
            dimValues = total.dimValues;                             // 维度数组

        let colourAll = queryJson.colour[0],                       // 全部属性 - 颜色
            sizeAll = queryJson.size[0],                             // 全部属性 - 尺寸
            angleAll = queryJson.angle[0],                           // 全部属性 - 角度
            detailAll = queryJson.detail[0],                         // 全部属性 - 细分
            labelAll = queryJson.label[0];                           // 全部属性 - 标签

        const legendData = chartLegendData(el,total,CStyle);                // 获取图例创建后的数据

        /*
        *  根据图例的宽度or高度以及位置，计算剩余图形的图形宽度和高度
        * */
        const widthO = parseInt($(id).css("width")) - margin.left - margin.right - legendData.elWidth;
        const height0 = parseInt($(id).css("height")) - margin.top - margin.bottom - legendData.elHeight;

        // 根据颜色编译成循环色
        const o = d3.scale.ordinal()
            .domain(legendData.colorDomain)
            .range(legendData.color);

        /*
        *  svg最外层，确定宽高度，确定位置
        * */
        const svg = d3.select(id).append("svg")
            .attr("width", widthO + margin.left + margin.right)
            .attr("height", height0 + margin.top + margin.bottom)
            .attr("transform", "translate(" + ( legendData.positionBur?legendData.elWidth:"0" ) + "," + ( legendData.positionBur?legendData.elHeight:"0" ) + ")")
            .append("svg:g")
            .attr("width", widthO )
            .attr("height", height0 )
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        //转换数据
        const pieData = d3.layout.pie() //创建饼状图
            .value(function (d) {   return d[angleAll.field];   })
            .sort(null)
            .startAngle([0]); //值访问器

        //绘制
        const outerRadius = d3.min([widthO,height0])/2;
        const innerRadius = 0; //内半径和外半径

        //创建弧生成器
        const arc = d3.svg.arc()
            .innerRadius(innerRadius)
            .outerRadius(outerRadius - 3);

        // 突出显示弧线生成器
        const arcHig = d3.svg.arc()
            .innerRadius(innerRadius)
            .outerRadius(outerRadius);



        const div = d3.select(id).append("div")
            .attr("class","message");

        //添加对应数目的弧组
        const arcs = svg.selectAll("g")
            .data(pieData(total.reoords))
            .enter()
            .append("g")
            .attr("transform", "translate(" + (widthO / 2) + "," + (height0 / 2) + ")");
        //添加弧的路径元素
        arcs.append("path")
            .attr("class","areaBlock")
            .attr("status",0)
            .attr("data-id",function (d){ if(colourAll){ return d.data[colourAll.field] } })
            .style("fill",function(d){ if(colourAll){ return o(d.data[colourAll.field]); }else{return defaultColor;}})
            .attr("d", function (d) {   return arc(d);  })
            .on({
                "mouseover":function(d){

                    /*
                    *   给每一个areaBlock元素添加一个状态；
                    *   状态0：有移入，移出效果；
                    *   状态1：没有移入和移出效果；
                    * */


                    const tx = parseFloat(d3.event.pageX - parseInt($(elemt).css("left")));
                    const ty = parseFloat(d3.event.pageY - parseInt($(elemt).css("top")));
                    div.style("display","block")
                        .style("top",(ty - margin.top - margin.bottom) + "px")
                        .style("left",(tx - margin.left - margin.right + 40) + "px")
                        .text("");

                    if(colourAll){  div.append("text").text( colourAll.fieldAlias + "：" + d.data[colourAll.field]);  }
                    if(sizeAll){    div.append("text").text( sizeAll.fieldAlias + "：" + d.data[sizeAll.field]);  }
                    if(detailAll){  div.append("text").text( detailAll.fieldAlias + "：" + d.data[detailAll.field]);  }
                    if(angleAll){   div.append("text").text( angleAll.fieldAlias + "：" + d.data[angleAll.field]);    }
                    if(labelAll){   div.append("text").text( labelAll.fieldAlias + "：" + d.data[labelAll.field]);    }

                    if(d3.select(this).attr("status") === "0"){
                        clickEffect(this,true,d);
                    }
                },
                "mousemove":function(){
                    const tx = parseFloat(d3.event.pageX - parseInt($(elemt).css("left")));
                    const ty = parseFloat(d3.event.pageY - parseInt($(elemt).css("top")));
                    div.style("top",(ty - margin.top - margin.bottom) + "px")
                        .style("left",(tx - margin.left - margin.right + 40) + "px")
                },
                "mouseout":function(d){
                    if(d3.select(this).attr("status") === "0"){
                        clickEffect(this,false,d);
                    }
                    div.style("display","none");
                },
                "click":function(d){
                    const le = $(".areaBlock[status=1]").length > 1;

                    if(d3.select(this).attr("status") === "0"){
                        clickEffect(this,true,d);
                        d3.select(this).attr("status",1);

                        $(this).attr("class","areaBlock");
                        $(".areaBlock[status=0]").attr("class","areaBlock fill-opacity");
                        console.log(le);
                        if(le){
                            $(this).attr("class","areaBlock fill-opacity");
                        }else{
                            $(this).attr("class","areaBlock");
                        }
                    }else{
                        clickEffect(this,false,d);
                        d3.select(this).attr("status",0);
                        if(le){
                            clickEffect(this,false,d);
                        }else{

                        }
                    }
                }
            });

        // 添加点击效果
        function clickEffect(self,bur,d){
            // 如果不是JQ对象，则转化为JQ对象！
            if(!(self instanceof jQuery)){
                self = $(self);
            }
            if(bur || bur === "true"){
                self.attr({
                    "d":arcHig(d),
                    "transform": "translate(" + arcHig.centroid(d)[0]/20 + "," + arcHig.centroid(d)[1]/20 + ")",
                    "stroke":"#000"
                })
            }else{
                self.attr({
                    "d":arc(d),
                    "transform": "translate(0,0)",
                    "stroke":"none"
                });
            }
        }

        //添加弧内的文字
//        arcs.append("text")
//            .attr("transform", function (d) {
//                var x = arc.centroid(d)[0] * 1.4; //文字的x坐标
//                var y = arc.centroid(d)[1] * 1.4;
//                return "translate(" + x + "," + y + ")";
//            })
//            .attr("text-anchor", "middle")
//            .text(function (d) {
////                //计算市场份额的百分比
////                var percent = Number(d.value) / d3.sum(total.reoords, function (d) {
////                    return d[angleAll.field];
////                }) * 100;
////                //保留一位小数点 末尾加一个百分号返回
////                return percent.toFixed(1) + "%";
//                return d.data[colourAll.field];
//            });
    }

</script>
</body>
</html>