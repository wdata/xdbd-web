{"version":3,"sources":["webpack:///../shared/modules/sync/SyncSignInManager.js"],"names":["SyncSignInManager","dbConfig","serviceReadyCallback","onSyncCallback","disconnectCallback","isServiceUp","onSync","onDisconnect","on","v","val","_downTimer","clearTimeout","setTimeout","data","error","successFn","errorFn","serviceAuthenticated","authenticateWithDataAndBind","authData","data_token","then","bindToResource","catch","e","syncRef","profile","user_id","documents","client","syncedAt","Date","now","setSyncData","value","key","syncObj","lastSyncedAt"],"mappings":";;;;;;;;;;;;qjBAAA;;;;;;;;;;;;;;;;;;;;AAoBA;;AAQA;;AACA;;;;IAEMA,iB;AACJ,mCAKG;AAAA,QAJDC,QAIC,QAJDA,QAIC;AAAA,QAHDC,oBAGC,QAHDA,oBAGC;AAAA,QAFDC,cAEC,QAFDA,cAEC;AAAA,qCADDC,kBACC;AAAA,QADDA,kBACC,yCADoB,IACpB;;AAAA;;AACD,wCAAWH,QAAX;AACA,SAAKI,WAAL,CAAiBH,oBAAjB;AACA,SAAKI,MAAL,GAAcH,cAAd;AACA,SAAKI,YAAL,GAAoBH,kBAApB;AACD;;;;gCACYF,oB,EAAsB;AAAA;;AACjC,wCAASM,EAAT,CAAY,OAAZ,EAAqB,aAAK;AACxB,YAAIC,EAAEC,GAAF,EAAJ,EAAa;AACX,cAAI,MAAKC,UAAT,EAAqB;AACnBC,yBAAa,MAAKD,UAAlB;AACA,mBAAO,MAAKA,UAAZ;AACD;AACDT;AACD,SAND,MAMO;AACL;AACA,gBAAKS,UAAL,GAAkBE,WAAW;AAAA,mBAAMX,oCAAN;AAAA,WAAX,EAA6C,KAA7C,CAAlB;AACD;AACF,OAXD;AAYD;;;iCACaY,I,EAAMC,K,EAAyC;AAAA,UAAlCC,SAAkC,uEAAtB,IAAsB;AAAA,UAAhBC,OAAgB,uEAAN,IAAM;;AAC3D,UAAIF,KAAJ,EAAW;AACT,aAAKG,oBAAL,GAA4B,KAA5B;AACA,aAAKH,KAAL,GAAaA,KAAb;AACAE,mBAAWA,QAAQF,KAAR,CAAX;AACD,OAJD,MAIO;AACL,aAAKI,2BAAL,CAAiCL,IAAjC,EAAuCE,SAAvC,EAAkDC,OAAlD;AACD;AACF;;;gDAC4BG,Q,EAA4C;AAAA;;AAAA,UAAlCJ,SAAkC,uEAAtB,IAAsB;AAAA,UAAhBC,OAAgB,uEAAN,IAAM;;AACvE,WAAKG,QAAL,GAAgBA,QAAhB;AACA,4CAAa,KAAKA,QAAL,CAAcC,UAA3B,EAAuC,KAAKd,YAA5C,EACGe,IADH,CACQ,aAAK;AACT,eAAKJ,oBAAL,GAA4B,IAA5B;AACA,eAAKH,KAAL,GAAa,IAAb;AACA,eAAKQ,cAAL;AACAP,qBAAaA,UAAUI,QAAV,CAAb;AACD,OANH,EAOGI,KAPH,CAOS,aAAK;AACV,eAAKN,oBAAL,GAA4B,KAA5B;AACA,eAAKH,KAAL,GAAaU,CAAb;AACAR,mBAAWA,QAAQQ,CAAR,CAAX;AACD,OAXH;AAYD;;;qCACiB;AAAA;;AAChB,WAAKC,OAAL,GAAe,wCAAe,KAAKN,QAAL,CAAcO,OAAd,CAAsBC,OAArC,CAAf;AACA,WAAKF,OAAL,CAAalB,EAAb,CAAgB,OAAhB,EAAyB,aAAK;AAC5B,YAAIC,EAAEC,GAAF,OAAY,IAAhB,EAAsB;AACpB,6CAAU,OAAKU,QAAL,CAAcO,OAAd,CAAsBC,OAAhC,EAAyC;AACvCC,uBAAW,CACT;AACEC,sBAAQ,4BADV;AAEEC,wBAAUC,KAAKC,GAAL;AAFZ,aADS;AAD4B,WAAzC;AAQD,SATD,MASO;AACL,iBAAKC,WAAL,CAAiBzB,EAAEC,GAAF,EAAjB;AACD;AACF,OAbD;AAcD;;;8BACU;AACT;AACD;;;gCACYyB,K,EAAO;AAClB,WAAK7B,MAAL,CAAY;AACV8B,aAAK,KAAKhB,QAAL,CAAcO,OAAd,CAAsBC,OADjB;AAEVS,iBAASF,KAFC;AAGVG,sBAAc,IAAIN,IAAJ;AAHJ,OAAZ;AAKD;;;;;;kBAGYhC,iB","file":"sync-manager.a7d86a4b010d6978d474.js","sourcesContent":["/*\r\n * Copyright (c) 2002-2017 \"Neo4j, Inc,\"\r\n * Network Engine for Objects in Lund AB [http://neotechnology.com]\r\n *\r\n * This file is part of Neo4j.\r\n *\r\n * Neo4j is free software: you can redistribute it and/or modify\r\n * it under the terms of the GNU General Public License as published by\r\n * the Free Software Foundation, either version 3 of the License, or\r\n * (at your option) any later version.\r\n *\r\n * This program is distributed in the hope that it will be useful,\r\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n * GNU General Public License for more details.\r\n *\r\n * You should have received a copy of the GNU General Public License\r\n * along with this program.  If not, see <http://www.gnu.org/licenses/>.\r\n */\r\n\r\nimport {\r\n  authenticate,\r\n  initialize,\r\n  status,\r\n  getResourceFor,\r\n  setupUser,\r\n  signOut\r\n} from 'services/browserSyncService'\r\nimport { getBrowserName } from 'services/utils'\r\nimport { UP, DOWN } from 'shared/modules/sync/syncDuck'\r\n\r\nclass SyncSignInManager {\r\n  constructor ({\r\n    dbConfig,\r\n    serviceReadyCallback,\r\n    onSyncCallback,\r\n    disconnectCallback = null\r\n  }) {\r\n    initialize(dbConfig)\r\n    this.isServiceUp(serviceReadyCallback)\r\n    this.onSync = onSyncCallback\r\n    this.onDisconnect = disconnectCallback\r\n  }\r\n  isServiceUp (serviceReadyCallback) {\r\n    status().on('value', v => {\r\n      if (v.val()) {\r\n        if (this._downTimer) {\r\n          clearTimeout(this._downTimer)\r\n          delete this._downTimer\r\n        }\r\n        serviceReadyCallback(UP)\r\n      } else {\r\n        // During connecting, the status is always down for a short time. So wait before setting state to be sure its really down\r\n        this._downTimer = setTimeout(() => serviceReadyCallback(DOWN), 10000)\r\n      }\r\n    })\r\n  }\r\n  authCallBack (data, error, successFn = null, errorFn = null) {\r\n    if (error) {\r\n      this.serviceAuthenticated = false\r\n      this.error = error\r\n      errorFn && errorFn(error)\r\n    } else {\r\n      this.authenticateWithDataAndBind(data, successFn, errorFn)\r\n    }\r\n  }\r\n  authenticateWithDataAndBind (authData, successFn = null, errorFn = null) {\r\n    this.authData = authData\r\n    authenticate(this.authData.data_token, this.onDisconnect)\r\n      .then(a => {\r\n        this.serviceAuthenticated = true\r\n        this.error = null\r\n        this.bindToResource()\r\n        successFn && successFn(authData)\r\n      })\r\n      .catch(e => {\r\n        this.serviceAuthenticated = false\r\n        this.error = e\r\n        errorFn && errorFn(e)\r\n      })\r\n  }\r\n  bindToResource () {\r\n    this.syncRef = getResourceFor(this.authData.profile.user_id)\r\n    this.syncRef.on('value', v => {\r\n      if (v.val() === null) {\r\n        setupUser(this.authData.profile.user_id, {\r\n          documents: [\r\n            {\r\n              client: getBrowserName(),\r\n              syncedAt: Date.now()\r\n            }\r\n          ]\r\n        })\r\n      } else {\r\n        this.setSyncData(v.val())\r\n      }\r\n    })\r\n  }\r\n  signOut () {\r\n    signOut()\r\n  }\r\n  setSyncData (value) {\r\n    this.onSync({\r\n      key: this.authData.profile.user_id,\r\n      syncObj: value,\r\n      lastSyncedAt: new Date()\r\n    })\r\n  }\r\n}\r\n\r\nexport default SyncSignInManager\r\n\n\n\n// WEBPACK FOOTER //\n// ../shared/modules/sync/SyncSignInManager.js"],"sourceRoot":""}